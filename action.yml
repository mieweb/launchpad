name: MIEWeb LaunchPad
description: Manage Containers via API
author: mieweb
branding:
  icon: "package"
  color: "purple"

inputs:
  api_key:
    description: "API Key for authentication"
    required: true
  api_url:
    description: "Base URL for the Container API (e.g., https://create-a-container.url/api)"
    required: true
  template_name:
    description: "LXC Template Name (replaces linux_distribution)"
    required: false
  public_key:
    description: "Public Key to inject into the container"
    required: false
  project_root:
    description: "Project root directory inside the container"
    required: false
  container_env_vars:
    description: "Environment variables to set inside the container (JSON string)"
    required: false
  install_command:
    description: "Command to install dependencies inside the container"
    required: false
  build_command:
    description: "Command to build the project inside the container"
    required: false
  start_command:
    description: "Command to start the application inside the container"
    required: false
  runtime_language:
    description: "Runtime language of the application (e.g., nodejs, python)"
    required: false
  services:
    description: "Services configuration object"
    required: false
  custom_services:
    description: "Custom services configuration"
    required: false
  multi_component:
    description: "Whether the project is multi-component"
    required: false
  root_start_command:
    description: "Start command to run as root inside the container"
    required: false
  github_pat:
    description: "GitHub Personal Access Token with repo permissions"
    required: false
  deploy_on_start:
    description: "Whether to deploy the application on container start"
    required: false
  require_services:
    description: "Whether services are required for the container"
    required: false

runs:
  using: "composite"
  steps:
    - name: Check if action should run
      shell: bash
      id: should-run
      env:
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_EVENT_CREATED: ${{ github.event.created }}
      run: |
        if [[ "$GITHUB_EVENT_NAME" != "push" ]] || [[ "$GITHUB_EVENT_CREATED" == "false" ]]; then
          echo "should_run=true" >> $GITHUB_OUTPUT
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "Skipping action: Push event with created=true"
        fi

    - name: Check if job is a create runner job
      shell: bash
      id: check-job
      env: 
         GITHUB_JOB: ${{ github.job }}
      run: |
        if [[ "$GITHUB_JOB" == *"setup"* || "$GITHUB_JOB" == *"runner"* ]]; then
          echo "runner_job=true" >> $GITHUB_OUTPUT
        else
          echo "runner_job=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Determine Target Branch Name
      shell: bash
      id: branch-name
      if: steps.should-run.outputs.should_run == 'true'
      env:
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_EVENT_REF: ${{ github.event.ref }}
      run: |
        if [[ "$GITHUB_EVENT_NAME" == "delete" ]]; then
          TARGET_BRANCH="$GITHUB_EVENT_REF"
          echo "Using deleted branch name: $TARGET_BRANCH"
        else
          TARGET_BRANCH="$GITHUB_REF_NAME"
          echo "Using current branch name: $TARGET_BRANCH"
        fi
        echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT

    - name: Create Runner (If Needed)
      shell: bash
      id: create-runner
      if: steps.should-run.outputs.should_run == 'true' && steps.check-job.outputs.runner_job == 'true' && github.event_name != 'delete'
      env:
        API_URL: ${{ inputs.api_url }}
        API_KEY: ${{ inputs.api_key }}
        GITHUB_REPOSITORY_FULL: ${{ github.repository }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        TARGET_BRANCH: ${{ steps.branch-name.outputs.target_branch }}
        GITHUB_PAT: ${{ inputs.github_pat }}
        GITHUB_API: ${{ github.api_url }}
        LINUX_DISTRIBUTION: ${{ inputs.template_name }}
        PROJECT_REPOSITORY: ${{ github.server_url }}/${{ github.repository }}
      run: |
        REPO_NAME=$(basename "$GITHUB_REPOSITORY_FULL")
        CONTAINER_NAME="${GITHUB_REPOSITORY_OWNER}-${REPO_NAME}-${TARGET_BRANCH}"
        CONTAINER_NAME=${CONTAINER_NAME,,}
        CONTAINER_NAME=$(echo "$CONTAINER_NAME" | sed 's/[^a-z0-9-]/-/g')
        export CONTAINER_NAME

        if [ ! -z "$GITHUB_PAT" ]; then
          RESPONSE=$(curl --location ${GITHUB_API}/repos/${GITHUB_REPOSITORY_OWNER}/${REPO_NAME}/actions/runners --header "Authorization: token $GITHUB_PAT")

          while read -r RUN; do
              RUNNER_NAME=$(echo "$RUN" | jq -r '.name')
              if [ "$RUNNER_NAME" == "$CONTAINER_NAME" ]; then
                  exit 0 # Runner exists, continue to next job.
              fi
          done < <(echo "$RESPONSE" | jq -c '.runners[]')

          echo "Creating a Runner via Proxmox API..."
          
          # Create runner via API with API Key authentication
          RUNNER_PAYLOAD=$(jq -n \
            --arg hostname "$CONTAINER_NAME" \
            --arg template "$LINUX_DISTRIBUTION" \
            --arg repo "$PROJECT_REPOSITORY" \
            --arg branch "$TARGET_BRANCH" \
            --arg github_pat "$GITHUB_PAT" \
            '{
              hostname: $hostname,
              template_name: $template,
              repository: $repo,
              branch: $branch,
              github_pat: $github_pat,
              runner: true
            }')

          CREATE_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "$API_URL/runners" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$RUNNER_PAYLOAD")

          if [ "$CREATE_CODE" -ge 200 ] && [ "$CREATE_CODE" -lt 300 ]; then
            echo "Runner created successfully via Proxmox API."
            exit 0
          else
            echo "::error::Failed to create runner via Proxmox API. HTTP: $CREATE_CODE"
            exit 1
          fi
        fi

    - name: Manage Container Lifecycle (Create/Update via API)
      id: manage-container
      shell: bash
      if: ${{ (github.event_name == 'create' || github.event_name == 'push') && steps.should-run.outputs.should_run == 'true' && steps.check-job.outputs.runner_job == 'false' }}
      env:
        API_URL: ${{ inputs.api_url }}
        USERNAME: ${{ inputs.username }}
        PASSWORD: ${{ inputs.password }}
        # Container Config
        TEMPLATE_NAME: ${{ inputs.template_name }}
        SERVICES: ${{ inputs.services }}
        CUSTOM_SERVICES: ${{ inputs.custom_services }}
        MULTI_COMPONENT: ${{ inputs.multi_component }}
        PROJECT_ROOT: ${{ inputs.project_root }}
        CONTAINER_ENV_VARS: ${{ inputs.container_env_vars }}
        INSTALL_COMMAND: ${{ inputs.install_command }}
        START_COMMAND: ${{ inputs.start_command }}
        BUILD_COMMAND: ${{ inputs.build_command }}
        RUNTIME_LANGUAGE: ${{ inputs.runtime_language }}
        ROOT_START_COMMAND: ${{ inputs.root_start_command }}
        DEPLOY_ON_START: ${{ inputs.deploy_on_start }}
        PUBLIC_KEY: ${{ inputs.public_key }}
        # Context
        GITHUB_REPOSITORY_FULL: ${{ github.repository }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        TARGET_BRANCH: ${{ steps.branch-name.outputs.target_branch }}
        PROJECT_REPOSITORY: ${{ github.server_url }}/${{ github.repository }}
      run: |
        # 1. Generate Container Name
        REPO_NAME=$(basename "$GITHUB_REPOSITORY_FULL")
        CONTAINER_NAME="${GITHUB_REPOSITORY_OWNER}-${REPO_NAME}-${TARGET_BRANCH}"
        CONTAINER_NAME=${CONTAINER_NAME,,}
        CONTAINER_NAME=$(echo "$CONTAINER_NAME" | sed 's/[^a-z0-9-]/-/g')
        
        echo "Managing Container: $CONTAINER_NAME"
        
        # 2. Check for existing container using API Key authentication
        EXISTING_CONTAINER=$(curl -s -H "Authorization: Bearer $API_KEY" "$API_URL/containers?hostname=$CONTAINER_NAME")
        CONTAINER_ID=$(echo "$EXISTING_CONTAINER" | jq -r '.[0].id // empty')

        # 4. Construct Payload
        # We construct a JSON object containing all necessary config
        PAYLOAD=$(jq -n \
          --arg hostname "$CONTAINER_NAME" \
          --arg template "$TEMPLATE_NAME" \
          --arg repo "$PROJECT_REPOSITORY" \
          --arg branch "$TARGET_BRANCH" \
          --arg root "$PROJECT_ROOT" \
          --arg install "$INSTALL_COMMAND" \
          --arg start "$START_COMMAND" \
          --arg build "$BUILD_COMMAND" \
          --arg language "$RUNTIME_LANGUAGE" \
          --arg root_start "$ROOT_START_COMMAND" \
          --arg public_key "$PUBLIC_KEY" \
          --arg services "$SERVICES" \
          --arg custom_services "$CUSTOM_SERVICES" \
          --arg env_vars "$CONTAINER_ENV_VARS" \
          '{
            hostname: $hostname,
            template_name: $template,
            repository: $repo,
            branch: $branch,
            project_root: $root,
            install_command: $install,
            start_command: $start,
            build_command: $build,
            runtime_language: $language,
            root_start_command: $root_start,
            public_key: $public_key,
            services: ($services | fromjson? // $services),
            custom_services: ($custom_services | fromjson? // $custom_services),
            env_vars: $env_vars
          }')

        # 5. Create or Update
        if [ -n "$CONTAINER_ID" ] && [ "$CONTAINER_ID" != "null" ]; then
          echo "Container exists (ID: $CONTAINER_ID). Updating..."
          UPDATE_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PUT "$API_URL/containers/$CONTAINER_ID" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          
          if [ "$UPDATE_CODE" -ge 200 ] && [ "$UPDATE_CODE" -lt 300 ]; then
            echo "Container updated successfully."
            echo "CONTAINER_CREATED=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Failed to update container. HTTP: $UPDATE_CODE"
            echo "FAILED=1" >> $GITHUB_ENV
            exit 1
          fi
        else
          echo "Container does not exist. Creating..."
          CREATE_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "$API_URL/containers" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          if [ "$CREATE_CODE" -ge 200 ] && [ "$CREATE_CODE" -lt 300 ]; then
            echo "Container created successfully."
            echo "CONTAINER_CREATED=true" >> $GITHUB_OUTPUT
          else
            echo "::error::Failed to create container. HTTP: $CREATE_CODE"
            echo "FAILED=1" >> $GITHUB_ENV
            exit 1
          fi
        fi

    - name: Container Deletion on Branch Deletion
      shell: bash
      if: ${{ github.event_name == 'delete' && steps.should-run.outputs.should_run == 'true' }}
      env:
        GITHUB_REPOSITORY_FULL: ${{ github.repository }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        TARGET_BRANCH: ${{ steps.branch-name.outputs.target_branch }}
        API_KEY: ${{ inputs.api_key }}
        API_URL: ${{ inputs.api_url }}
      run: |
        REPO_NAME=$(basename "$GITHUB_REPOSITORY_FULL")
        CONTAINER_NAME="${GITHUB_REPOSITORY_OWNER}-${REPO_NAME}-${TARGET_BRANCH}"
        CONTAINER_NAME=${CONTAINER_NAME,,}
        CONTAINER_NAME=$(echo "$CONTAINER_NAME" | sed 's/[^a-z0-9-]/-/g')

        # Query /containers endpoint to get container.id using API Key authentication
        CONTAINERS_RESPONSE=$(curl -s -H "Authorization: Bearer $API_KEY" "$API_URL/containers?hostname=$CONTAINER_NAME")
        CONTAINER_ID=$(echo "$CONTAINERS_RESPONSE" | jq -r '.[0].id // empty')
        
        # DELETE /containers/:id
        if [ -n "$CONTAINER_ID" ] && [ "$CONTAINER_ID" != "null" ]; then
          DELETE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $API_KEY" -X DELETE "$API_URL/containers/$CONTAINER_ID")
          if [ "$DELETE_CODE" -eq 200 ] || [ "$DELETE_CODE" -eq 204 ]; then
             echo "Container $CONTAINER_NAME (ID: $CONTAINER_ID) has been deleted"
          else
             echo "::warning::Failed to delete container. HTTP: $DELETE_CODE"
          fi
        else
          echo "No container found to delete"
        fi

    - name: Check if branch is part of a PR and comment
      shell: bash
      id: check-pr
      if: steps.should-run.outputs.should_run == 'true' && steps.check-job.outputs.runner_job == 'false' && env.FAILED != '1'
      env:
        GITHUB_TOKEN: ${{ inputs.github_pat }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        TARGET_BRANCH: ${{ steps.branch-name.outputs.target_branch }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        RUN_ID: ${{ github.run_id }}
        API_URL: ${{ inputs.api_url }}
      run: |
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "pr_number=" >> $GITHUB_OUTPUT
          echo "is_pr=false" >> $GITHUB_OUTPUT
          echo "No GitHub token provided, skipping PR detection"
          exit 0
        fi
        
        # Check if this branch has an open PR
        PR_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls?state=open&head=${{ github.repository_owner }}:$TARGET_BRANCH")
        
        PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number // empty')
        
        if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "is_pr=true" >> $GITHUB_OUTPUT
          echo "Branch $TARGET_BRANCH is part of PR #$PR_NUMBER"
          
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          CONTAINER_NAME="${GITHUB_REPOSITORY_OWNER}-${REPO_NAME}-${TARGET_BRANCH}"
          CONTAINER_NAME=${CONTAINER_NAME,,}
          CONTAINER_NAME=$(echo "$CONTAINER_NAME" | sed 's/[^a-z0-9-]/-/g')
          # Extract domain from API URL for container URL
          API_DOMAIN=$(echo "$API_URL" | sed -E 's|https?://([^/]+).*|\1|')
          CONTAINER_URL="https://${CONTAINER_NAME}.${API_DOMAIN}"

          COMMENT_BODY="## ðŸš€ Proxmox LaunchPad Action
          **Expected URL**: [$CONTAINER_NAME]($CONTAINER_URL) *(will be available once deployment completes)*
          **Status**: âœ… Application was deployed via API.
          **Branch**: \`$TARGET_BRANCH\`
          **Run ID**: [\`$RUN_ID\`](https://github.com/$GITHUB_REPOSITORY/actions/runs/$RUN_ID)
          **Container Name**: \`$CONTAINER_NAME\`"

          JSON_PAYLOAD=$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')

          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" \
            -d "$JSON_PAYLOAD" > /dev/null

          echo "Initial comment posted to PR #$PR_NUMBER"
        else
          echo "pr_number=" >> $GITHUB_OUTPUT
          echo "is_pr=false" >> $GITHUB_OUTPUT
          echo "Branch $TARGET_BRANCH is not part of any open PR"
        fi

    - name: Comment on PR on Failure
      if: env.FAILED == '1'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_pat }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        TARGET_BRANCH: ${{ steps.branch-name.outputs.target_branch }}
        RUN_ID: ${{ github.run_id }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        API_URL: ${{ inputs.api_url }}
      run: |
        if [ -z "$GITHUB_TOKEN" ]; then
          echo "Cannot comment on PR: missing token"
          exit 1
        fi

        PR_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls?state=open&head=${GITHUB_REPOSITORY_OWNER}:$TARGET_BRANCH")
        
        PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number // empty')

        if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" == "null" ]; then
          echo "Not a pull request, skipping failure comment."
          exit 0
        fi

        REPO_NAME=$(basename "$GITHUB_REPOSITORY")
        CONTAINER_NAME="${GITHUB_REPOSITORY_OWNER}-${REPO_NAME}-${TARGET_BRANCH}"
        CONTAINER_NAME=${CONTAINER_NAME,,}
        CONTAINER_NAME=$(echo "$CONTAINER_NAME" | sed 's/[^a-z0-9-]/-/g')
        # Extract domain from API URL for container URL
        API_DOMAIN=$(echo "$API_URL" | sed -E 's|https?://([^/]+).*|\1|')
        CONTAINER_URL="https://${CONTAINER_NAME}.${API_DOMAIN}"

        COMMENT_BODY="## ðŸš€ Proxmox LaunchPad Action
        **Expected URL**: [$CONTAINER_NAME]($CONTAINER_URL) *(will be available once deployment completes)*
        **Status**: âŒ Application failed to deploy. View [\`$RUN_ID\`](https://github.com/$GITHUB_REPOSITORY/actions/runs/$RUN_ID) to see logs.
        **Branch**: \`$TARGET_BRANCH\`
        **Run ID**: [\`$RUN_ID\`](https://github.com/$GITHUB_REPOSITORY/actions/runs/$RUN_ID)
        **Container Name**: \`$CONTAINER_NAME\`"

        JSON_PAYLOAD=$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')

        curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" \
          -d "$JSON_PAYLOAD" > /dev/null

        echo "Failure comment posted to PR #$PR_NUMBER"
        exit 1

    - name: Create GitHub Deployment (Default Branch)
      if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch) && env.FAILED != '1'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_pat }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF: ${{ github.ref }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
      run: |
        REPO_NAME=$(basename "$GITHUB_REPOSITORY")
        CONTAINER_NAME="${GITHUB_REPOSITORY_OWNER}-${REPO_NAME}-${GITHUB_REF#refs/heads/}"
        CONTAINER_NAME=${CONTAINER_NAME,,}
        CONTAINER_NAME=$(echo "$CONTAINER_NAME" | sed 's/[^a-z0-9-]/-/g')
        # Extract domain from API URL for container URL
        API_DOMAIN=$(echo "$API_URL" | sed -E 's|https?://([^/]+).*|\1|')
        CONTAINER_URL="https://${CONTAINER_NAME}.${API_DOMAIN}"
        DEPLOYMENT_RESPONSE=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/deployments" \
          -d '{
            "ref": "'${GITHUB_REF#refs/heads/}'",
            "required_contexts": [],
            "environment": "Preview - '$GITHUB_REPOSITORY'",
            "description": "Deployment triggered from Proxmox LaunchPad action.",
            "sha": "'$GITHUB_SHA'"
          }')
        DEPLOYMENT_ID=$(echo "$DEPLOYMENT_RESPONSE" | jq -r '.id')
        if [ "$DEPLOYMENT_ID" != "null" ] && [ -n "$DEPLOYMENT_ID" ]; then
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/deployments/$DEPLOYMENT_ID/statuses" \
            -d '{
              "state": "success",
              "description": "Deployment completed successfully.",
              "environment": "Preview - '$GITHUB_REPOSITORY'",
              "environment_url": "'$CONTAINER_URL'"
            }' > /dev/null
          echo "Deployment created and marked as successful for default branch: ${GITHUB_REF#refs/heads/}"
          echo "Deployment URL: $CONTAINER_URL"
        else
          echo "Deployment creation failed."
        fi

    - name: Catch All Failure Step
      if: env.FAILED == '1'
      shell: bash
      run: |
        echo "Workflow failed. See previous steps for details."
        exit 1